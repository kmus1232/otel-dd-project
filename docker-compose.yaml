version: '3'
services:
  # 1. FastAPI 앱 서비스
  fastapi-app:
    build: .
    ports:
      - "8000:8000"
    environment:
      - DD_SERVICE=my-fastapi-service  # 데이터독에 표시될 서비스 이름
      - DD_ENV=dev                     # 환경 (prod, dev, stg)
      - DD_VERSION=1.0.0
      - DD_AGENT_HOST=datadog-agent    # 아래 정의한 에이전트 서비스 이름
      - DD_TRACE_ANALYTICS_ENABLED=true
      - DD_TRACE_OTEL_ENABLED=true
      - DD_CODE_ORIGIN_FOR_SPANS_ENABLED=true
    depends_on:
      - datadog-agent

  # 2. Datadog 에이전트 서비스
  datadog-agent:
    image: gcr.io/datadoghq/agent:7
    environment:
      - DD_API_KEY=${DD_API_KEY}  # .env 파일에서 로드
      - DD_APM_ENABLED=true                # APM 활성화 필수
      - DD_APM_NON_LOCAL_TRAFFIC=true      # 다른 컨테이너의 트래픽 허용
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /proc/:/host/proc/:ro
      - /sys/fs/cgroup/:/host/sys/fs/cgroup:ro